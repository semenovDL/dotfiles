#!/bin/sh
#
# dot
#
# `dot` handles installation, updates, things like that. Run it periodically
# to make sure you're on the latest and greatest.
export DOTFILES=$HOME/.dotfiles

set -e

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.macos` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# find the installers and run them iteratively
echo "› $DOTFILES/*/install.sh"
find $DOTFILES -name install.sh -mindepth 2 |
  while read installer ; do sh -c "${installer}" ; done

# Upgrade homebrew
echo "› brew update"
brew update
echo "› brew upgrade"
brew upgrade

# Cleanup
echo "> brew bundle cleanup"
brew bundle cleanup --force --file=$DOTFILES/brew/brewfile.rb
echo "> brew cleanup"
brew cleanup

# The Brewfile handles Homebrew-based app and library installs, but there may
# still be updates and installables in the Mac App Store. There's a nifty
# command line interface to it that we can use to just install everything, so
# yeah, let's do that.
echo "› sudo softwareupdate -i -a"
sudo softwareupdate -i -a
